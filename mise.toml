# cfgate mise configuration

[env]
_.file = ["secrets.enc.yaml", ".env"]
IMG = "cfgate:local"
REGISTRY = "ghcr.io/inherent-design/cfgate"

[tools]
go = "1.25"
"aqua:kubernetes-sigs/kind" = "0.31.0"
"aqua:kubernetes/kubernetes/kubectl" = "1.35.0"
"aqua:kubernetes-sigs/kustomize" = "5.8.0"
"aqua:golangci/golangci-lint" = "2.8.0"
"github:kubernetes-sigs/controller-tools[exe=controller-gen]" = "0.20.0"
"go:github.com/onsi/ginkgo/v2/ginkgo" = "2.28.1"

#
# Development
#

[tasks.codegen]
description = "Generate DeepCopy and CRD manifests"
run = """
controller-gen object:headerFile="hack/boilerplate.go.txt" paths="./..."
controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config=config/crd/bases
"""

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run"

[tasks."lint:fix"]
description = "Run golangci-lint with auto-fix"
run = "golangci-lint run --fix"

[tasks.format]
alias = ["fmt"]
description = "Format and vet code"
run = "go fmt ./... && go vet ./..."

#
# Build
#

[tasks.manifests]
description = "Generate release manifests to dist/"
depends = ["codegen"]
run = """
mkdir -p dist
cp config/crd/bases/*.yaml dist/
kustomize build config/default > dist/install.yaml
echo "Release manifests written to dist/"
ls -la dist/
"""

[tasks.build]
alias = "b"
description = "Build manager binary"
depends = ["codegen"]
run = "CGO_ENABLED=0 go build -o bin/manager ./cmd/manager"

#
# Testing
#

[tasks.e2e]
description = "Run E2E tests against live Cloudflare API"
env = { E2E_USE_EXISTING_CLUSTER = "true" }
run = """
echo "Running E2E tests against live Cloudflare API"
mkdir -p out
ginkgo -vv -p --keep-going --silence-skips --poll-progress-after=15s \
  --output-dir out \
  --json-report=e2e-run.json \
  --cover --covermode atomic --coverprofile coverage.out \
  --race \
  ./test/e2e
"""

[tasks."e2e:cleanup"]
alias = ["clean"]
description = "Clean up orphaned E2E test resources from Cloudflare"
run = "go run ./cmd/cleanup"

#
# Cluster - Local Development
#

[tasks."cluster:create"]
description = "Create dedicated cfgate test cluster"
run = """
kind create cluster --name cfgate-test --wait 5m
kubectl cluster-info --context kind-cfgate-test
"""

[tasks."cluster:delete"]
description = "Delete cfgate test cluster"
run = "kind delete cluster --name cfgate-test"

[tasks."cluster:status"]
description = "Check cfgate test cluster status"
run = "kind get clusters | grep cfgate-test && kubectl --context kind-cfgate-test get nodes || echo 'cfgate-test cluster not found'"

#
# Deploy - Local Development
#

[tasks."local:install"]
description = "Install CRDs into current cluster"
depends = ["codegen"]
run = "kustomize build config/crd | kubectl apply -f -"

[tasks."local:deploy"]
description = "Deploy controller to current cluster"
depends = ["codegen", "docker:build"]
run = """
cd config/manager && kustomize edit set image controller=${IMG}
kustomize build config/default | kubectl apply -f -
"""

[tasks."local:undeploy"]
description = "Remove controller from current cluster"
run = "kustomize build config/default | kubectl delete --ignore-not-found -f -"

[tasks."local:uninstall"]
description = "Uninstall CRDs from current cluster"
run = "kustomize build config/crd | kubectl delete --ignore-not-found -f -"

#
# Controller
#

[tasks.run]
description = "Run controller locally (outside cluster)"
run = "go run ./cmd/manager"

#
# Docker
#

[tasks."docker:build"]
alias = "db"
description = "Build Docker image"
run = "docker build -t ${IMG} ."

[tasks."docker:push"]
alias = "dp"
description = "Push Docker image to registry"
run = """
docker tag ${IMG} ${REGISTRY}:latest
docker push ${REGISTRY}:latest
"""

[tasks."docker:buildx"]
description = "Build multi-arch image (amd64 + arm64)"
run = """
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  -t ${REGISTRY}:latest \
  --push .
"""
